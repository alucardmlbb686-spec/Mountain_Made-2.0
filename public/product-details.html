<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-enhancements.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .product-detail-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }
        
        @media (max-width: 768px) {
            .product-detail-container {
                margin: 1rem auto;
                padding: 0 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-detail-container {
                margin: 0.5rem auto;
                padding: 0 0.75rem;
            }
        }
        
        .product-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 968px) {
            .product-detail-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-detail-grid {
                gap: 1rem;
                margin-bottom: 1rem;
            }
        }
        
        .product-image-section {
            position: static;
            height: fit-content;
        }
        
        .product-main-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-md);
            cursor: zoom-in;
        }
        
        @media (max-width: 768px) {
            .product-main-image {
                border-radius: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .product-main-image {
                margin-bottom: 0.75rem;
            }
        }
        
        .product-thumbnails {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        
        @media (max-width: 480px) {
            .product-thumbnails {
                gap: 0.5rem;
            }
        }
        
        .product-thumbnail {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid var(--border-primary);
            transition: border-color 0.2s;
        }
        
        @media (max-width: 480px) {
            .product-thumbnail {
                border-radius: 6px;
            }
        }
        
        .product-thumbnail:hover,
        .product-thumbnail.active {
            border-color: var(--primary-500);
        }

        .image-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.88);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 2200;
        }

        .image-lightbox.hidden {
            display: none;
        }

        .image-lightbox img {
            max-width: min(96vw, 1400px);
            max-height: 90vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.55);
        }

        .image-lightbox-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 42px;
            height: 42px;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.45);
            color: #fff;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .image-lightbox-close:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .product-info-section h1 {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .product-title-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .product-share {
            position: relative;
            flex: 0 0 auto;
        }

        .product-share-btn {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .product-share-btn:hover {
            background: var(--bg-tertiary);
        }

        .product-share-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 220px;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
            padding: 0.5rem;
            z-index: 50;
        }

        .product-share-menu button {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.6rem;
            padding: 0.65rem 0.75rem;
            border: 0;
            border-radius: 10px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
        }

        .product-share-menu button:hover {
            background: var(--bg-secondary);
        }

        .product-share-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem 0.5rem;
        }
        
        @media (max-width: 768px) {
            .product-info-section h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-info-section h1 {
                font-size: 1.25rem;
                line-height: 1.4;
            }
        }
        
        .product-rating {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-primary);
            color: var(--warning);
        }
        
        @media (max-width: 768px) {
            .product-rating {
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-rating {
                gap: 0.35rem;
                font-size: 0.85rem;
            }
        }
        
        .product-price-section {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            border: 1px solid var(--border-primary);
        }
        
        @media (max-width: 768px) {
            .product-price-section {
                padding: 1.25rem;
                margin: 1rem 0;
            }
        }
        
        @media (max-width: 480px) {
            .product-price-section {
                padding: 1rem;
                border-radius: 8px;
            }
        }
        
        .product-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.5rem;
        }

        .product-total-price {
            margin-top: 0.45rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        @media (max-width: 768px) {
            .product-price {
                font-size: 1.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-price {
                font-size: 1.5rem;
            }
        }
        
        .product-stock {
            background: var(--success-bg);
            color: var(--text-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            display: inline-block;
            margin: 1rem 0;
            border: 1px solid rgba(16, 185, 129, 0.35);
            animation: productStockGlowGreen 1.8s ease-in-out infinite;
        }
        
        @media (max-width: 480px) {
            .product-stock {
                padding: 0.4rem 0.85rem;
                font-size: 0.9rem;
            }
        }
        
        .product-stock.low {
            background: var(--warning-bg);
            color: var(--text-primary);
            border-color: rgba(245, 158, 11, 0.45);
            animation: productStockGlowAmber 1.8s ease-in-out infinite;
        }
        
        .product-stock.out {
            background: var(--error-bg);
            color: var(--text-primary);
            border-color: rgba(239, 68, 68, 0.48);
            animation: productStockGlowRed 1.8s ease-in-out infinite;
        }

        @keyframes productStockGlowGreen {
            0%, 100% { box-shadow: 0 0 0 rgba(16, 185, 129, 0); }
            50% { box-shadow: 0 0 14px rgba(16, 185, 129, 0.45); }
        }

        @keyframes productStockGlowAmber {
            0%, 100% { box-shadow: 0 0 0 rgba(245, 158, 11, 0); }
            50% { box-shadow: 0 0 14px rgba(245, 158, 11, 0.42); }
        }

        @keyframes productStockGlowRed {
            0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { box-shadow: 0 0 14px rgba(239, 68, 68, 0.45); }
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .quantity-selector {
                margin: 1rem 0;
            }
        }
        
        @media (max-width: 480px) {
            .quantity-selector {
                gap: 0.75rem;
                font-size: 0.9rem;
            }
        }
        
        .product-actions {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        @media (max-width: 768px) {
            .product-actions {
                margin: 1rem 0;
            }
        }
        
        @media (max-width: 640px) {
            .product-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .product-actions .btn {
                width: 100%;
            }
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .quantity-selector label {
            font-weight: 600;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
        }
        
        .quantity-controls button {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-primary);
            transition: background 0.2s;
        }
        
        @media (max-width: 480px) {
            .quantity-controls button {
                padding: 0.4rem 0.85rem;
                font-size: 1.1rem;
            }
        }
        
        .quantity-controls button:hover {
            background: var(--bg-tertiary);
        }
        
        .quantity-controls input {
            width: 60px;
            text-align: center;
            border: none;
            padding: 0.5rem;
            font-size: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        @media (max-width: 480px) {
            .quantity-controls input {
                width: 50px;
                padding: 0.4rem;
                font-size: 0.95rem;
            }
        }
        
        .product-actions {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .product-actions .btn {
            flex: 1;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        @media (max-width: 480px) {
            .product-actions .btn {
                padding: 0.85rem;
                font-size: 0.95rem;
            }
        }
        
        .product-description {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-primary);
        }
        
        @media (max-width: 768px) {
            .product-description {
                margin-top: 1.5rem;
                padding-top: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-description {
                margin-top: 1rem;
                padding-top: 1rem;
                font-size: 0.9rem;
            }
        }
        
        .product-description h3 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        
        @media (max-width: 768px) {
            .product-description h3 {
                font-size: 1.15rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-description h3 {
                font-size: 1.05rem;
                margin-bottom: 0.75rem;
            }
        }
        
        .product-specs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .product-specs {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .product-specs {
                gap: 0.5rem;
                margin-top: 1rem;
            }
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border-primary);
        }
        
        @media (max-width: 480px) {
            .spec-item {
                padding: 0.65rem;
                font-size: 0.9rem;
            }
        }
        
        .spec-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .spec-value {
            color: var(--text-secondary);
        }
        
        .delivery-info {
            background: var(--success-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid var(--success);
        }
        
        @media (max-width: 768px) {
            .delivery-info {
                padding: 1.25rem;
                margin: 1rem 0;
            }
        }
        
        @media (max-width: 480px) {
            .delivery-info {
                padding: 1rem;
                font-size: 0.9rem;
            }
        }
        
        .delivery-info h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
        }
        
        @media (max-width: 480px) {
            .delivery-info h4 {
                font-size: 1rem;
            }
        }
        
        .delivery-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            color: var(--text-primary);
        }
        
        @media (max-width: 480px) {
            .delivery-option {
                gap: 0.4rem;
                font-size: 0.9rem;
            }
        }

        /* Address selection modal styling (make clearly visible) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050;
            padding: 1.25rem;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 1.75rem 1.5rem 1.75rem;
            border-radius: 12px;
            width: 100%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            border: 1px solid var(--border-primary);
        }
        
        @media (max-width: 768px) {
            .modal-content {
                padding: 1.5rem 1.25rem;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                padding: 1.25rem 1rem;
                border-radius: 10px;
                max-height: 85vh;
            }
        }

        .modal-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .modal-header-row h3 {
            margin: 0;
            font-size: 1.4rem;
        }
        
        @media (max-width: 480px) {
            .modal-header-row h3 {
                font-size: 1.2rem;
            }
        }

        .modal-close-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 999px;
        }

        .modal-close-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .address-option {
            background: var(--bg-secondary);
        }
        
        /* Account Dropdown Styles */
        .account-menu {
            position: relative;
        }

        .account-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            min-width: 280px;
            z-index: 1000;
            border: 1px solid var(--border-primary);
        }

        .account-dropdown.hidden {
            display: none;
        }

        .account-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .account-section:last-child {
            border-bottom: none;
        }

        .account-section strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .account-link {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 0.2s;
            display: block;
            text-align: left;
            margin-top: 0.5rem;
        }

        .account-link:hover {
            background: var(--primary-100);
            border-color: var(--primary-400);
        }

        .account-link-danger {
            background: var(--error-bg);
            color: var(--error);
            border-color: var(--error);
        }

        .account-link-danger:hover {
            background: var(--error);
            color: white;
        }

        .account-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            padding: 0.25rem 0;
        }

        /* ── Dark mode overrides ── */
        html[data-theme="dark"] .product-main-image,
        html[data-theme="dark"] .product-thumbnail {
            background: var(--bg-secondary);
            border-color: var(--border-primary);
        }

        html[data-theme="dark"] .product-price-section {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        html[data-theme="dark"] .delivery-info {
            background: rgba(6, 125, 98, 0.12);
            border-left-color: #059669;
        }

        html[data-theme="dark"] .delivery-info h4,
        html[data-theme="dark"] .delivery-option {
            color: var(--text-primary);
        }

        html[data-theme="dark"] .product-stock {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.30);
            color: #6ee7b7;
        }

        html[data-theme="dark"] .product-stock.low {
            background: rgba(217, 119, 6, 0.15);
            border-color: rgba(217, 119, 6, 0.30);
            color: #fcd34d;
        }

        html[data-theme="dark"] .product-stock.out {
            background: rgba(192, 57, 43, 0.15);
            border-color: rgba(192, 57, 43, 0.30);
            color: #fca5a5;
        }

        html[data-theme="dark"] .quantity-controls {
            border-color: var(--border-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        html[data-theme="dark"] .quantity-controls button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        html[data-theme="dark"] .quantity-controls button:hover {
            background: var(--border-secondary);
        }

        html[data-theme="dark"] .quantity-controls input {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html[data-theme="dark"] .spec-item {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }

        html[data-theme="dark"] .product-share-menu {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
            box-shadow: 0 10px 24px rgba(0,0,0,0.45);
        }

        html[data-theme="dark"] .product-share-menu button:hover {
            background: var(--border-primary);
        }

        html[data-theme="dark"] .modal-content {
            background: var(--bg-primary);
            border-color: var(--border-secondary);
        }

        html[data-theme="dark"] .image-lightbox {
            background: rgba(0,0,0,0.92);
        }

    </style>
</head>
<body>
    <nav class="navbar">
        <span class="nav-corner nav-corner-tl" aria-hidden="true"></span>
        <span class="nav-corner nav-corner-tr" aria-hidden="true"></span>
        <span class="nav-corner nav-corner-bl" aria-hidden="true"></span>
        <span class="nav-corner nav-corner-br" aria-hidden="true"></span>
        <div class="navbar-container">
            <button class="mobile-menu-toggle" aria-label="Open navigation menu">
                <i class="fas fa-bars"></i>
            </button>
            <a href="/" class="navbar-brand">
                <span class="navbar-tagline">GOURMET GROCERIES</span>
            </a>
            <ul class="navbar-menu">
                <li><a href="/">Home</a></li>
                <li><a href="/products">Products</a></li>
                <li id="admin-link" class="hidden"><a href="/admin">Admin</a></li>
            </ul>
            <div class="navbar-actions">
                <div id="auth-buttons"><a href="/login" class="btn btn-secondary btn-sm">Login</a></div>
                <div id="user-menu" class="hidden flex gap-2" style="align-items: center;">
                    <a href="/cart" class="icon-button"><i class="fas fa-shopping-cart"></i><span id="cart-badge" class="cart-badge hidden">0</span></a>
                    <div class="account-menu">
                        <button id="account-toggle" class="icon-button" title="Account">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div id="account-dropdown" class="account-dropdown hidden">
                            <div class="account-section">
                                <strong>Account</strong>
                                <button class="account-link" onclick="openProfileModal()">Edit Profile</button>
                                <a href="/orders" class="account-link">My Orders</a>
                            </div>
                            <div class="account-section">
                                <strong>Account Management</strong>
                                <button class="account-link" onclick="openAccountManagementModal()">Change Password</button>
                            </div>
                            <div class="account-section">
                                <strong>Appearance</strong>
                                <button id="theme-toggle" class="account-link">Toggle Dark / Light</button>
                            </div>
                            <div class="account-section">
                                <button id="account-logout" class="account-link account-link-danger">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="product-detail-container">
        <div id="product-content" class="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <div id="image-lightbox" class="image-lightbox hidden" onclick="handleLightboxBackdropClick(event)">
        <button type="button" class="image-lightbox-close" onclick="closeImageLightbox()" aria-label="Close fullscreen image">
            <i class="fas fa-times"></i>
        </button>
        <img id="lightbox-image" src="" alt="Product image preview">
    </div>

    <script src="/js/main.js"></script>
    <script>
        let product = null;
        let selectedQuantity = 1;
        let userAddresses = [];

        function getQuantityStep() {
            const isWholesaleUser = !!(auth && typeof auth.isWholesale === 'function' && auth.isWholesale());
            if (!isWholesaleUser) return 1;
            const raw = parseInt((product && product.min_wholesale_qty) || 10, 10);
            return Number.isFinite(raw) && raw > 0 ? raw : 10;
        }

        function getCurrentPricing() {
            if (!product) return { basePrice: 0, salePrice: 0, showDiscount: false, isWholesale: false };

            const isWholesale = auth.isWholesale();
            const basePrice = parseFloat(product.price || 0);
            const discount = product.discount_price != null ? parseFloat(product.discount_price) : null;
            const retailPrice = discount != null && discount < basePrice ? discount : basePrice;
            const salePrice = isWholesale && product.wholesale_price ? parseFloat(product.wholesale_price) : retailPrice;
            const showDiscount = !isWholesale && discount != null && discount < basePrice;

            return { basePrice, salePrice, showDiscount, isWholesale };
        }

        function updateDisplayedPrice() {
            const pricing = getCurrentPricing();
            const qty = Number(selectedQuantity) > 0 ? Number(selectedQuantity) : 1;

            const salePriceEl = document.getElementById('product-sale-price');
            const basePriceEl = document.getElementById('product-base-price');
            const totalPriceEl = document.getElementById('product-total-price');
            const perUnitHintEl = document.getElementById('product-price-hint');

            const saleTotal = pricing.salePrice * qty;
            const baseTotal = pricing.basePrice * qty;

            if (salePriceEl) {
                salePriceEl.textContent = formatCurrency(saleTotal);
            }

            if (basePriceEl) {
                if (pricing.showDiscount) {
                    basePriceEl.textContent = formatCurrency(baseTotal);
                    basePriceEl.style.display = '';
                } else {
                    basePriceEl.style.display = 'none';
                }
            }

            if (totalPriceEl) {
                totalPriceEl.textContent = qty > 1
                    ? `Total for ${qty} items`
                    : 'Total for 1 item';
            }

            if (perUnitHintEl) {
                perUnitHintEl.textContent = `Per item: ${formatCurrency(pricing.salePrice)}`;
            }
        }

        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                window.location.href = '/products';
                return;
            }

            try {
                const data = await api.get(`/products/${productId}`);
                product = data.product;
                renderProduct();
            } catch (error) {
                console.error('Failed to load product:', error);
                document.getElementById('product-content').innerHTML = 
                    '<p class="text-center">Product not found</p>';
            }
        }

        async function loadUserAddresses() {
            if (!auth.isAuthenticated()) return;
            
            try {
                const data = await api.get('/addresses');
                userAddresses = data.addresses;
            } catch (error) {
                console.error('Failed to load addresses:', error);
            }
        }

        function getUnitInfo(p) {
            const rawUnit = (p && typeof p.unit === 'string') ? p.unit.trim() : '';
            if (rawUnit) return { unit: rawUnit, per: rawUnit };

            const weightNum = p && p.weight != null ? parseFloat(p.weight) : NaN;
            if (Number.isFinite(weightNum) && weightNum > 0) return { unit: 'kg', per: 'kg' };

            // Friendly fallback so we never show "Unit: unit"
            return { unit: 'pcs', per: 'piece' };
        }

        function renderProduct() {
            const isWholesale = auth.isWholesale();
            const qtyStep = getQuantityStep();
            selectedQuantity = qtyStep;
            const unitInfo = getUnitInfo(product);
            const basePrice = parseFloat(product.price || 0);
            const discount = product.discount_price != null ? parseFloat(product.discount_price) : null;
            const retailPrice = discount != null && discount < basePrice ? discount : basePrice;
            const salePrice = isWholesale && product.wholesale_price ? parseFloat(product.wholesale_price) : retailPrice;
            const showDiscount = !isWholesale && discount != null && discount < basePrice;
            const inStock = product.stock_quantity > 0;
            const lowStock = product.stock_quantity > 0 && product.stock_quantity < 10;
            const fallbackImage = '/images/placeholder.jpg';

            let productImages = [];
            if (Array.isArray(product.images)) {
                productImages = product.images;
            } else if (typeof product.images === 'string' && product.images.trim()) {
                try {
                    const parsedImages = JSON.parse(product.images);
                    if (Array.isArray(parsedImages)) {
                        productImages = parsedImages;
                    }
                } catch (_) {
                    productImages = product.images.split(',').map(img => img.trim());
                }
            }

            productImages = productImages
                .filter(img => typeof img === 'string' && img.trim())
                .map(img => img.trim());

            if (product.image_url && !productImages.includes(product.image_url)) {
                productImages.unshift(product.image_url);
            }

            if (productImages.length === 0) {
                productImages = [fallbackImage];
            }
            
            document.title = `${product.name}`;
            
            const content = `
                <div class="product-detail-grid">
                    <div class="product-image-section">
                        <img src="${productImages[0]}" 
                             alt="${product.name}" 
                             id="product-main-image"
                             class="product-main-image"
                                onclick="openImageLightbox(this.src, this.alt)"
                             onerror="this.src='/images/placeholder.jpg'">
                        ${productImages.length > 1 ? `
                            <div class="product-thumbnails" id="product-thumbnails">
                                ${productImages.map((image, index) => `
                                    <img src="${image}" 
                                         alt="${product.name} image ${index + 1}" 
                                         class="product-thumbnail ${index === 0 ? 'active' : ''}"
                                         data-image="${image}"
                                         onclick="selectProductImage(this)"
                                         onerror="this.src='/images/placeholder.jpg'">
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="product-info-section">
                        <div class="product-title-row">
                            <h1>${product.name}</h1>
                            <div class="product-share">
                                <button type="button" class="product-share-btn" onclick="toggleProductShareMenu(event)" aria-label="Share product">
                                    <i class="fas fa-share-nodes"></i>
                                </button>
                                <div id="product-share-menu" class="product-share-menu hidden" role="menu" aria-label="Share options">
                                    <div class="product-share-hint">Share this product</div>
                                    <button type="button" onclick="shareProduct('whatsapp')" role="menuitem">
                                        <i class="fab fa-whatsapp"></i> WhatsApp
                                    </button>
                                    <button type="button" onclick="shareProduct('facebook')" role="menuitem">
                                        <i class="fab fa-facebook"></i> Facebook
                                    </button>
                                    <button type="button" onclick="shareProduct('instagram')" role="menuitem">
                                        <i class="fab fa-instagram"></i> Instagram
                                    </button>
                                    <button type="button" onclick="shareProduct('native')" role="menuitem">
                                        <i class="fas fa-share-from-square"></i> More…
                                    </button>
                                    <button type="button" onclick="shareProduct('copy')" role="menuitem">
                                        <i class="fas fa-link"></i> Copy link
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="product-price-section">
                            <div class="product-price">
                                <span id="product-base-price" style="text-decoration: line-through; color: var(--error); font-size: 0.9em; margin-right: 8px; ${showDiscount ? '' : 'display:none;'}">${formatCurrency(basePrice)}</span>
                                <span id="product-sale-price" style="color: var(--primary-600); font-weight: 700;">${formatCurrency(salePrice)}</span>
                                <div id="product-total-price" class="product-total-price">Total for 1 item</div>
                            </div>
                            ${isWholesale && product.wholesale_price ? 
                                `<small style="color: var(--text-secondary);">Wholesale Price • Min Order: ${product.min_wholesale_qty} units</small>` : 
                                `<small style="color: var(--text-secondary);">Per ${unitInfo.per}</small>`
                            }
                            <div id="product-price-hint" style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">Per item: ${formatCurrency(salePrice)}</div>
                            
                            <div class="product-stock ${lowStock ? 'low' : ''} ${!inStock ? 'out' : ''}" style="margin-top: 1rem;">
                                ${inStock ? 
                                    (lowStock ? `⚠️ Only ${product.stock_quantity} left in stock` : '✓ In Stock') : 
                                    '✗ Out of Stock'
                                }
                            </div>
                            
                            ${inStock ? `
                                <div class="quantity-selector">
                                    <label>Quantity:</label>
                                    <div class="quantity-controls">
                                        <button onclick="decrementQuantity()">-</button>
                                        <input type="number" id="quantity" value="${selectedQuantity}" min="${qtyStep}" step="${qtyStep}" max="${product.stock_quantity}" 
                                                   onchange="updateQuantity(this.value)" oninput="updateQuantity(this.value)">
                                        <button onclick="incrementQuantity()">+</button>
                                    </div>
                                </div>
                                
                                <div class="product-actions">
                                    <button class="btn btn-primary" onclick="handleAddToCart()">
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>
                                    <button class="btn btn-success" onclick="handleBuyNow()">
                                        <i class="fas fa-bolt"></i> Buy Now
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="delivery-info">
                            <h4><i class="fas fa-truck"></i> Delivery Information</h4>
                            <div class="delivery-option">
                                <i class="fas fa-check-circle"></i>
                                <span>Standard delivery: 3-5 days</span>
                            </div>
                            <div class="delivery-option">
                                <i class="fas fa-check-circle"></i>
                                <span>Express delivery available</span>
                            </div>
                        </div>
                        
                        <div class="product-description">
                            <h3>About this product</h3>
                            <p>${product.description || 'No description available.'}</p>
                        </div>
                        
                        <div class="product-specs">
                            <div class="spec-item">
                                <span class="spec-label">Category:</span>
                                <span>${product.category_name || 'N/A'}</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-label">Unit:</span>
                                <span>${unitInfo.unit}</span>
                            </div>
                            ${product.weight ? `
                                <div class="spec-item">
                                    <span class="spec-label">Weight:</span>
                                    <span>${product.weight} ${unitInfo.unit}</span>
                                </div>
                            ` : ''}
                            <div class="spec-item">
                                <span class="spec-label">Stock:</span>
                                <span>${product.stock_quantity} available</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('product-content').innerHTML = content;
            updateDisplayedPrice();
        }

        function getShareUrl() {
            if (product && product.id != null) {
                return `${window.location.origin}/product-details?id=${encodeURIComponent(String(product.id))}`;
            }
            return window.location.href;
        }

        function getSharePayload() {
            const url = getShareUrl();
            const pricing = getCurrentPricing();
            const priceText = pricing?.salePrice ? formatCurrency(pricing.salePrice) : '';
            const title = product?.name ? String(product.name) : 'Product';
            const text = priceText ? `${title} (${priceText})` : title;
            return { title, text, url };
        }

        function toggleProductShareMenu(event) {
            try { event?.stopPropagation?.(); } catch (_) { /* ignore */ }
            const menu = document.getElementById('product-share-menu');
            if (!menu) return;

            const isHidden = menu.classList.contains('hidden');
            // Close any open menu first
            menu.classList.add('hidden');
            if (isHidden) {
                menu.classList.remove('hidden');
            }
        }

        function closeProductShareMenu() {
            const menu = document.getElementById('product-share-menu');
            if (!menu) return;
            menu.classList.add('hidden');
        }

        async function copyTextToClipboard(value) {
            const text = String(value || '').trim();
            if (!text) return false;
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
            } catch (_) {
                // fall through
            }

            try {
                const el = document.createElement('textarea');
                el.value = text;
                el.setAttribute('readonly', '');
                el.style.position = 'fixed';
                el.style.top = '-1000px';
                el.style.left = '-1000px';
                document.body.appendChild(el);
                el.select();
                const ok = document.execCommand('copy');
                document.body.removeChild(el);
                return !!ok;
            } catch (_) {
                return false;
            }
        }

        async function shareProduct(target) {
            closeProductShareMenu();
            const { title, text, url } = getSharePayload();
            const message = `${text}\n${url}`.trim();

            const safeOpen = (shareUrl) => {
                try {
                    window.open(shareUrl, '_blank', 'noopener,noreferrer');
                } catch (_) {
                    window.location.href = shareUrl;
                }
            };

            if (target === 'copy') {
                const ok = await copyTextToClipboard(url);
                if (typeof showAlert === 'function') {
                    showAlert(ok ? 'Link copied!' : 'Copy failed. Please copy the link from the address bar.', ok ? 'success' : 'error');
                } else {
                    alert(ok ? 'Link copied!' : 'Copy failed.');
                }
                return;
            }

            // Native share (best way to share into WhatsApp/Facebook/Instagram apps on mobile)
            if (target === 'native' || target === 'instagram') {
                if (navigator.share) {
                    try {
                        await navigator.share({ title, text, url });
                        return;
                    } catch (_) {
                        // user cancelled or not supported for this payload
                    }
                }
            }

            if (target === 'whatsapp') {
                safeOpen(`https://wa.me/?text=${encodeURIComponent(message)}`);
                return;
            }

            if (target === 'facebook') {
                safeOpen(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`);
                return;
            }

            if (target === 'instagram') {
                // Instagram doesn't support a reliable web share URL like WhatsApp/Facebook.
                // Real working path on mobile is the native share sheet; otherwise copy link.
                const ok = await copyTextToClipboard(url);
                safeOpen('https://www.instagram.com/');
                if (typeof showAlert === 'function') {
                    showAlert(ok ? 'Link copied. Paste it in Instagram.' : 'Open Instagram and paste the link.', ok ? 'success' : 'info');
                }
                return;
            }
        }

        function selectProductImage(thumbnailElement) {
            const mainImage = document.getElementById('product-main-image');
            if (!mainImage || !thumbnailElement) return;

            const newImage = thumbnailElement.getAttribute('data-image');
            if (!newImage) return;

            mainImage.src = newImage;
            document.querySelectorAll('.product-thumbnail').forEach((thumbnail) => {
                thumbnail.classList.remove('active');
            });
            thumbnailElement.classList.add('active');
        }

        function openImageLightbox(imageSrc, imageAlt = 'Product image') {
            if (!imageSrc) return;
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            if (!lightbox || !lightboxImage) return;

            lightboxImage.src = imageSrc;
            lightboxImage.alt = imageAlt;
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeImageLightbox() {
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            if (!lightbox || !lightboxImage) return;

            lightbox.classList.add('hidden');
            lightboxImage.src = '';
            document.body.style.overflow = '';
        }

        function handleLightboxBackdropClick(event) {
            if (event.target && event.target.id === 'image-lightbox') {
                closeImageLightbox();
            }
        }

        function updateQuantity(value) {
            const step = getQuantityStep();
            const maxQty = parseInt(product.stock_quantity, 10);
            const hasMax = Number.isFinite(maxQty) && maxQty > 0;

            let qty = parseInt(value, 10);
            if (!Number.isFinite(qty) || qty <= 0) qty = step;

            if (hasMax && maxQty < step) {
                selectedQuantity = maxQty;
                document.getElementById('quantity').value = selectedQuantity;
                updateDisplayedPrice();
                return;
            }

            qty = Math.max(step, qty);
            if (hasMax) qty = Math.min(qty, maxQty);

            if (step > 1) {
                qty = Math.ceil(qty / step) * step;
                if (hasMax && qty > maxQty) {
                    qty = Math.floor(maxQty / step) * step;
                }
                qty = Math.max(step, qty);
            }

            if (hasMax) qty = Math.min(qty, maxQty);

            selectedQuantity = qty;
            document.getElementById('quantity').value = selectedQuantity;
            updateDisplayedPrice();
        }

        function incrementQuantity() {
            const step = getQuantityStep();
            const maxQty = parseInt(product.stock_quantity, 10);
            const hasMax = Number.isFinite(maxQty) && maxQty > 0;

            if (hasMax && maxQty < step) {
                selectedQuantity = maxQty;
                document.getElementById('quantity').value = selectedQuantity;
                updateDisplayedPrice();
                return;
            }

            const next = selectedQuantity + step;
            if (!hasMax || next <= maxQty) {
                selectedQuantity = next;
                document.getElementById('quantity').value = selectedQuantity;
                updateDisplayedPrice();
            }
        }

        function decrementQuantity() {
            const step = getQuantityStep();
            const next = Math.max(step, selectedQuantity - step);
            if (next !== selectedQuantity) {
                selectedQuantity = next;
                document.getElementById('quantity').value = selectedQuantity;
                updateDisplayedPrice();
            }
        }

        async function handleAddToCart() {
            if (!auth.isAuthenticated()) {
                showAlert('Please login to add items to cart', 'error');
                setTimeout(() => window.location.href = '/login', 1500);
                return;
            }

            try {
                await cart.add(product.id, selectedQuantity);
                showAlert(`${selectedQuantity} ${product.name}(s) added to cart!`, 'success');
            } catch (error) {
                console.error('Add to cart error:', error);
                showAlert('Failed to add to cart', 'error');
            }
        }

        async function handleBuyNow() {
            if (!auth.isAuthenticated()) {
                showAlert('Please login to buy products', 'error');
                setTimeout(() => window.location.href = '/login', 1500);
                return;
            }

            // Load addresses if not loaded
            if (userAddresses.length === 0) {
                await loadUserAddresses();
            }

            // If user has addresses, show selection modal
            if (userAddresses.length > 0) {
                showAddressSelectionModal();
            } else {
                // No addresses, redirect to address management
                if (await showConfirmDialog('You need to add a delivery address first. Go to address management?', { title: 'Address Required', confirmText: 'Go to Addresses' })) {
                    window.location.href = '/addresses';
                }
            }
        }

        function showAddressSelectionModal() {
            const defaultAddress = userAddresses.find(a => a.is_default) || userAddresses[0];
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header-row">
                        <h3>Select Delivery Address</h3>
                        <button type="button" class="modal-close-btn" onclick="this.closest('.modal-overlay').remove()" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="margin: 1.5rem 0;">
                        ${userAddresses.map(addr => `
                            <div class="address-option" style="margin-bottom: 1rem; padding: 1rem; border: 2px solid ${addr.id === defaultAddress.id ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer;" 
                                 onclick="selectAddress(${addr.id})">
                                <input type="radio" name="address" value="${addr.id}" ${addr.id === defaultAddress.id ? 'checked' : ''}>
                                <strong>${addr.label}</strong>
                                <p style="margin: 0.5rem 0 0 1.5rem; color: var(--text-secondary);">
                                    ${addr.full_name}<br>
                                    ${addr.address_line1}${addr.address_line2 ? ', ' + addr.address_line2 : ''}<br>
                                    ${addr.city}, ${addr.state} ${addr.postal_code}<br>
                                    ${addr.phone}
                                </p>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin: 0 0 1.25rem; padding: 1rem; border: 1px solid var(--border); border-radius: 10px; background: var(--bg-secondary);">
                        <h4 style="margin: 0 0 0.75rem;">Payment Method</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label">Select Payment</label>
                            <select id="quick_payment_method" class="form-select" required>
                                <option value="cash_on_delivery">Cash on Delivery</option>
                                <option value="gpay">Google Pay (UPI)</option>
                            </select>
                        </div>
                        <div id="quick-gpay-details" class="hidden">
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label class="form-label">GPay detail to share</label>
                                <select id="quick-gpay-detail-type" class="form-select">
                                    <option value="upi">UPI ID</option>
                                    <option value="phone">Phone Number</option>
                                    <option value="qr">QR Code / Link</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label id="quick-gpay-detail-label" class="form-label">UPI ID</label>
                                <input type="text" id="quick-gpay-detail-value" class="form-input" placeholder="e.g. name@upi">
                                <div class="form-help">This is shared only with the owner for payment confirmation.</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmBuyNow()">Confirm Order</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.selectedAddressId = defaultAddress.id;

            const paymentSelect = document.getElementById('quick_payment_method');
            if (paymentSelect) {
                paymentSelect.addEventListener('change', toggleQuickGpayDetails);
            }
            toggleQuickGpayDetails();
        }

        function formatQuickGpayLabel(type) {
            if (type === 'phone') return 'Phone Number';
            if (type === 'qr') return 'QR Code / Link';
            return 'UPI ID';
        }

        function toggleQuickGpayDetails() {
            const paymentSelect = document.getElementById('quick_payment_method');
            const gpaySection = document.getElementById('quick-gpay-details');
            const typeSelect = document.getElementById('quick-gpay-detail-type');
            const labelEl = document.getElementById('quick-gpay-detail-label');
            const valueInput = document.getElementById('quick-gpay-detail-value');
            if (!paymentSelect || !gpaySection) return;

            const isGpay = paymentSelect.value === 'gpay';
            gpaySection.classList.toggle('hidden', !isGpay);

            if (typeSelect && labelEl) {
                labelEl.textContent = formatQuickGpayLabel(typeSelect.value);
                typeSelect.onchange = () => {
                    labelEl.textContent = formatQuickGpayLabel(typeSelect.value);
                    if (valueInput) valueInput.placeholder = typeSelect.value === 'phone' ? 'e.g. +91 98765 43210' : (typeSelect.value === 'qr' ? 'e.g. link or description' : 'e.g. name@upi');
                };
            }
        }

        function selectAddress(addressId) {
            window.selectedAddressId = addressId;
            document.querySelectorAll('.address-option').forEach(el => {
                el.style.borderColor = 'var(--border)';
            });
            event.currentTarget.style.borderColor = 'var(--primary)';
        }

        async function confirmBuyNow() {
            const addressId = window.selectedAddressId;
            const address = userAddresses.find(a => a.id === addressId);
            
            if (!address) {
                showAlert('Please select an address', 'error');
                return;
            }

            try {
                const paymentMethod = document.getElementById('quick_payment_method')?.value || 'cash_on_delivery';
                let notes = 'Quick Buy Order';

                if (paymentMethod === 'gpay') {
                    const type = document.getElementById('quick-gpay-detail-type')?.value || 'upi';
                    const value = (document.getElementById('quick-gpay-detail-value')?.value || '').trim();
                    if (!value) {
                        showAlert(`Please enter your ${formatQuickGpayLabel(type)} for GPay.`, 'error');
                        return;
                    }
                    notes = `GPay via ${formatQuickGpayLabel(type)}: ${value}`;
                }

                const response = await api.post('/orders/quick-buy', {
                    product_id: product.id,
                    quantity: selectedQuantity,
                    shipping_address: {
                        address_id: address.id,
                        full_name: address.full_name,
                        phone: address.phone,
                        address_line1: address.address_line1,
                        address_line2: address.address_line2,
                        city: address.city,
                        state: address.state,
                        postal_code: address.postal_code,
                        country: address.country
                    },
                    payment_method: paymentMethod,
                    notes
                });
                
                document.querySelector('.modal-overlay').remove();
                showAlert('Order placed successfully! Order #' + response.order.order_number, 'success');
                setTimeout(() => window.location.href = '/orders', 2000);
            } catch (error) {
                console.error('Buy now error:', error);
                showAlert(error.message || 'Failed to place order', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await auth.checkAuth();
            await cart.fetch();
            await loadProduct();
            await loadUserAddresses();

            // Close share menu on outside click
            document.addEventListener('click', () => {
                closeProductShareMenu();
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeImageLightbox();
                    closeProductShareMenu();
                }
            });

            // Account dropdown toggle
            const accountToggle = document.getElementById('account-toggle');
            const accountDropdown = document.getElementById('account-dropdown');

            if (accountToggle && accountDropdown) {
                accountToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    accountDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.account-menu')) {
                        accountDropdown.classList.add('hidden');
                    }
                });
            }

            // Account logout handler
            const accountLogout = document.getElementById('account-logout');
            if (accountLogout) {
                accountLogout.addEventListener('click', async () => {
                    if (await showConfirmDialog('Are you sure you want to logout?', { title: 'Logout', confirmText: 'Logout' })) {
                        await auth.logout();
                    }
                });
            }
        });
    </script>
</body>
</html>
