<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c5f2d">
    <link rel="manifest" href="/manifest.json">
    <title>Mountain Made</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-enhancements.css">
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    <style>
        /* ══ Hero Slider Section ══ */
        .search-section {
            position: relative;
            padding: clamp(2.5rem, 8vw, 5rem) 1rem;
            margin-bottom: 2.5rem;
            min-height: clamp(320px, 45vw, 520px);
            display: flex;
            align-items: center;
        }

        /* Slide backgrounds — absolute, stacked, crossfade */
        .hero-slides-container {
            position: absolute;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        .hero-slide {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            background-color: #0f3823; /* fallback green */
        }

        .hero-slide.active {
            opacity: 1;
        }

        /* Dark overlay on every slide so text is readable */
        .hero-slide::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(10,40,20,0.70) 0%, rgba(10,40,20,0.52) 100%);
        }

        /* Slider dot navigation */
        .hero-slider-dots {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 3;
        }

        .hero-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.45);
            cursor: pointer;
            transition: background 0.3s, transform 0.3s;
            border: none;
        }

        .hero-dot.active {
            background: #fff;
            transform: scale(1.3);
        }

        /* Content sits above slides */
        .search-container {
            max-width: 980px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            width: 100%;
        }


        .search-heading {
            max-width: 840px;
            margin: 0 auto 1.25rem;
            text-align: center;
            min-height: clamp(64px, 12vw, 108px);
        }

        .search-heading.hidden {
            display: block;
            visibility: hidden;
        }

        .search-heading h1 {
            margin: 0 0 0.5rem;
            font-size: clamp(1.8rem, 4.8vw, 3.2rem);
            line-height: 1.15;
            color: #ffffff;
            letter-spacing: -0.02em;
        }

        .search-heading p {
            margin: 0;
            color: rgba(255,255,255,0.9);
            font-size: clamp(0.98rem, 1.8vw, 1.2rem);
        }

        .homepage-section-heading-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.85rem;
            width: 100%;
            max-width: 100%;
            margin: 0;
        }

        .homepage-section-heading-text {
            text-align: center;
            width: min(100%, 980px);
            margin: 0 auto;
            padding: 0 1rem;
        }

        .homepage-section-heading-text h2 {
            margin: 0 0 0.4rem 0;
        }

        .homepage-section-heading-text p {
            margin: 0;
        }

        /* Force section-title block when it contains a heading image */
        .section-title:has(.homepage-section-heading-wrap) {
            display: block;
            width: 100%;
            border-bottom: none;
            padding-bottom: 0;
        }

        .homepage-section-heading-image-box {
            width: 100%;
            max-width: 100%;
            margin: 0 auto 0.75rem auto;
            aspect-ratio: 20 / 8;
            max-height: clamp(140px, 22vw, 300px);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .homepage-section-heading-image-box.hidden {
            display: none;
        }

        .homepage-section-heading-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Homepage product cards - compact sizing + better image fit */
        #homepage-sections-container .product-card .card-image {
            width: 100%;
            height: auto;
            aspect-ratio: 4 / 3;
            max-height: 180px;
            object-fit: contain;
            background: var(--bg-secondary);
            display: block;
        }

        #homepage-sections-container .product-card .stock-info {
            margin-top: 0.15rem;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        #homepage-sections-container .product-card .card-content {
            padding: 0.75rem 0.9rem 0.8rem;
        }

        #homepage-sections-container .product-card .card-description {
            margin-bottom: var(--space-2);
            -webkit-line-clamp: 1;
            line-clamp: 1;
        }

        #homepage-sections-container .product-card .product-price {
            font-size: 1.35rem;
            color: var(--primary-700);
        }

        #homepage-sections-container .product-card .card-footer {
            padding: 0 0.9rem 0.9rem;
            gap: 0.45rem;
        }

        #homepage-sections-container .product-card .card-footer .btn {
            padding: 0.45rem 0.6rem;
            font-size: 0.78rem;
        }

        #homepage-sections-container .product-card .add-cart-cta {
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        #homepage-sections-container .product-card .card-footer .btn i {
            font-size: 0.8em;
        }


        @media (max-width: 768px) {
            #homepage-sections-container .product-card .card-image {
                max-height: 110px;
            }

            #homepage-sections-container .product-card .card-content {
                padding: 0.5rem 0.65rem 0.65rem;
            }

            #homepage-sections-container .product-card .card-footer {
                padding: 0 0.65rem 0.65rem;
            }
        }

        @media (max-width: 600px) {
            #homepage-sections-container .product-card .card-description {
                display: none;
            }

            #homepage-sections-container .product-card .product-qty-row {
                display: none !important;
            }

            #homepage-sections-container .product-card .card-footer {
                flex-direction: column;
                align-items: stretch;
            }

            #homepage-sections-container .product-card .card-footer .btn {
                width: 100% !important;
                margin-left: 0 !important;
            }

            #homepage-sections-container .product-card .product-action-row {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.25rem;
                width: 100%;
            }

            #homepage-sections-container .product-card .product-action-row .btn {
                width: 100% !important;
                min-width: 0;
                padding: 0.34rem 0.2rem;
                font-size: 0.64rem;
                gap: 0.2rem;
                line-height: 1.1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #homepage-sections-container .product-card .product-action-row .btn i {
                display: none;
            }
        }

        .search-input-wrapper {
            display: flex;
            gap: 0.75rem;
            box-shadow: 0 16px 36px rgba(0,0,0,0.2);
            border-radius: 14px;
            overflow: hidden;
            background: var(--bg-primary);
            border: 1px solid rgba(255,255,255,0.45);
        }

        .search-input-zone {
            position: relative;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            border: none;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .search-input:focus {
            box-shadow: inset 0 0 0 2px rgba(58,145,83,0.2);
        }

        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 0.5rem);
            margin-top: 0.5rem;
            background: var(--bg-primary);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 320px;
            overflow-y: auto;
            z-index: 50;
        }

        .search-suggestion-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            gap: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-primary);
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .search-suggestion-item:hover {
            background: var(--bg-secondary);
        }

        .search-suggestion-image {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .search-suggestion-text {
            display: flex;
            flex-direction: column;
        }

        .search-suggestion-name {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .search-suggestion-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .search-suggestions-empty {
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .search-button {
            padding: 1rem 1.5rem;
            background: var(--primary-900);
            color: white;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .search-button:hover {
            background: var(--primary-800);
        }

        .home-trust-strip {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .home-trust-item {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.7rem;
            border-radius: 999px;
            background: rgba(255,255,255,0.14);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.24);
            font-size: 0.78rem;
            font-weight: 500;
        }

        .home-trust-item i {
            color: #facc15;
        }

        /* ══ Flip Cards Section ══ */
        .flip-cards-section {
            padding: 2.5rem 0 3rem;
            background: linear-gradient(135deg, #f0f7ff 0%, #f9fbe7 100%);
        }

        .flip-cards-container {
            max-width: 1360px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .flip-cards-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 1.5rem;
        }

        .flip-cards-header h2 {
            font-size: 1.55rem;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.02em;
        }

        .flip-cards-header .fc-badge {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: linear-gradient(90deg, #ff5722, #e64a19);
            color: #fff;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 9px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .flip-cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.1rem;
        }

        .flip-card-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .flip-card {
            perspective: 1000px;
            width: 100%;
            aspect-ratio: 3/4;
            cursor: pointer;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.72s cubic-bezier(0.35, 0.15, 0.15, 1);
            transform-style: preserve-3d;
        }

        .flip-card:hover .flip-card-inner,
        .flip-card.auto-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            inset: 0;
            border-radius: 16px;
            overflow: hidden;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            box-shadow: 0 6px 24px rgba(0,0,0,0.12);
        }

        .flip-card-front {
            background: linear-gradient(145deg, #fce4ec, #e3f2fd);
        }

        .flip-card-back {
            transform: rotateY(180deg);
            background: linear-gradient(145deg, #e8f5e9, #ede7f6);
        }

        .flip-card-img-wrap {
            width: 100%;
            height: 72%;
            overflow: hidden;
        }

        .flip-card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.5s;
        }

        .flip-card-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #ccc;
            background: linear-gradient(135deg, #f5f5f5, #eeeeee);
        }

        .flip-card-ad-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.55);
            backdrop-filter: blur(4px);
            color: #fff;
            font-size: 0.62rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.08em;
            z-index: 2;
        }

        .flip-card-cta-bar {
            height: 28%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            font-weight: 700;
            color: #fff;
            text-align: center;
            padding: 0.4rem 0.5rem;
            line-height: 1.25;
            letter-spacing: 0.01em;
        }

        /* CTA color schemes per card slot */
        .flip-card-wrap:nth-child(1) .flip-card-front .flip-card-cta-bar,
        .flip-card-wrap[data-slot="1"] .flip-card-front .flip-card-cta-bar {
            background: linear-gradient(90deg, #1e88e5, #1565c0);
        }
        .flip-card-wrap:nth-child(2) .flip-card-front .flip-card-cta-bar,
        .flip-card-wrap[data-slot="2"] .flip-card-front .flip-card-cta-bar {
            background: linear-gradient(90deg, #ff8c00, #e07000);
        }
        .flip-card-wrap:nth-child(3) .flip-card-front .flip-card-cta-bar,
        .flip-card-wrap[data-slot="3"] .flip-card-front .flip-card-cta-bar {
            background: linear-gradient(90deg, #2e8b57, #1b5e20);
        }
        .flip-card-wrap:nth-child(4) .flip-card-front .flip-card-cta-bar,
        .flip-card-wrap[data-slot="4"] .flip-card-front .flip-card-cta-bar {
            background: linear-gradient(90deg, #7b1fa2, #4a148c);
        }
        .flip-card-wrap:nth-child(5) .flip-card-front .flip-card-cta-bar,
        .flip-card-wrap[data-slot="5"] .flip-card-front .flip-card-cta-bar {
            background: linear-gradient(90deg, #c62828, #b71c1c);
        }

        .flip-card-back .flip-card-cta-bar {
            background: linear-gradient(90deg, rgba(0,0,0,0.72), rgba(0,0,0,0.55));
            backdrop-filter: blur(6px);
        }

        .flip-card-back .flip-card-ad-badge {
            background: rgba(255,255,255,0.2);
        }

        .flip-card-subtitle {
            margin-top: 0.55rem;
            font-size: 0.83rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 1100px) {
            .flip-cards-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 640px) {
            .flip-cards-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .flip-cards-header h2 { font-size: 1.2rem; }
        }

        /* Carousel Styles */
        .carousel-section {
            background: var(--bg-secondary);
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .carousel-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .carousel-title {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .carousel-wrapper {
            position: relative;
        }

        .carousel-track-container {
            overflow: hidden;
            border-radius: 12px;
            min-height: 300px;
        }

        .carousel-track {
            display: flex;
            gap: 1rem;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-item {
            min-width: 280px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            flex-shrink: 0;
        }

        .carousel-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .carousel-item-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: var(--bg-secondary);
        }

        .carousel-item-content {
            padding: 1rem;
        }

        .carousel-item-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }

        .carousel-item-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.75rem;
        }

        .carousel-stock-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 600;
            margin-bottom: 0.45rem;
            background: var(--warning);
            color: #1f2937;
        }

        .carousel-stock-badge.out {
            background: var(--error);
            color: #ffffff;
        }

        .carousel-item-footer {
            display: flex;
            gap: 0.5rem;
        }

        .carousel-item-footer .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--border-primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .carousel-nav:hover {
            background: var(--bg-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .carousel-prev {
            left: -24px;
        }

        .carousel-next {
            right: -24px;
        }

        .carousel-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .homepage-section-heading-image-box {
                aspect-ratio: 20 / 8;
                max-height: clamp(120px, 40vw, 220px);
            }

            .search-input-wrapper {
                flex-direction: column;
                gap: 0;
            }

            .search-button {
                padding: 0.875rem;
            }

            .search-suggestions {
                max-height: 260px;
            }

            .carousel-item {
                min-width: 240px;
            }

            .carousel-track-container {
                min-height: 260px;
            }

            .carousel-nav {
                width: 40px;
                height: 40px;
            }

            .carousel-prev {
                left: 4px;
            }

            .carousel-next {
                right: 4px;
            }
        }

        @media (max-width: 480px) {
            .carousel-item {
                min-width: 200px;
            }

            .carousel-track-container {
                min-height: 240px;
            }
        }

        /* ── Mobile hero: search bar top, image+heading below ── */
        @media (max-width: 768px) {
            .search-section {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                padding: 0;
                min-height: unset;
                margin-bottom: 1.5rem;
                background-color: #fff;
                position: relative;
            }

            /* 1. Search bar at very top — clean white, compact */
            .search-container {
                order: 1;
                position: static;
                z-index: 3;
                background: #fff;
                padding: 0.75rem 1rem 0.7rem;
                width: 100%;
                max-width: 100%;
                box-shadow: 0 2px 8px rgba(0,0,0,0.09);
            }

            /* Pull heading OUT of search-container flow → float over image.
               search-container height ≈ 12px pad + 52px input + 52px button + 10px pad = 126px
               Add ~20px into the image = top: 146px */
            #search-hero-heading {
                position: absolute;
                top: 146px;
                left: 0;
                right: 0;
                z-index: 5;
                text-align: center;
                padding: 0.5rem 1rem 0;
                min-height: 0;
                margin: 0;
                pointer-events: none;
            }

            #search-hero-heading.hidden {
                display: none;
            }

            /* Don't let .search-heading min-height reserve space */
            .search-heading {
                min-height: 0 !important;
            }

            /* Hide trust strip to keep search bar compact */
            .home-trust-strip {
                display: none;
            }

            /* 2. Hero image block below the search bar */
            .hero-slides-container {
                order: 2;
                position: relative;
                inset: auto;
                width: 100%;
                height: clamp(200px, 52vw, 320px);
                z-index: 1;
                overflow: hidden;
            }

            /* 3. Dots below image */
            .hero-slider-dots {
                order: 3;
                position: relative;
                bottom: auto;
                left: auto;
                transform: none;
                padding: 0.35rem 0 0.3rem;
                background: #f0f0f0;
                justify-content: center;
                z-index: 2;
            }

            /* Stronger dark gradient at top so heading text stays readable */
            .hero-slide::after {
                background: linear-gradient(
                    180deg,
                    rgba(5,20,10,0.78) 0%,
                    rgba(5,20,10,0.48) 55%,
                    rgba(5,20,10,0.15) 100%
                );
            }

            /* When a dedicated mobile bg is set, the whole section becomes the canvas */
            .search-section.has-mobile-bg {
                background-size: cover;
                background-position: center top;
                background-repeat: no-repeat;
            }

            /* Keep search box readable but let image show through */
            .search-section.has-mobile-bg .search-container {
                background: rgba(255,255,255,0.65);
                backdrop-filter: blur(2px);
                -webkit-backdrop-filter: blur(2px);
            }

            /* #mobile-hero-bg-wrap not used in the new approach */
            #mobile-hero-bg-wrap { display: none !important; }

            /* Clean white search input card */
            .search-input-wrapper {
                background: #fff;
                border-radius: 12px;
                border: 1.5px solid #e0e0e0;
                box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            }
        }

        /* Categories carousel (circular tiles, single row) */
        .category-carousel {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.65rem;
        }

        .category-carousel .carousel-track-container {
            min-height: 170px;
            overflow: hidden;
            border-radius: 12px;
            width: min(100%, 920px);
        }

        .category-carousel .carousel-nav {
            position: static;
            top: auto;
            left: auto;
            right: auto;
            transform: none;
            width: 44px;
            height: 44px;
        }

        .category-track {
            display: flex;
            flex-wrap: nowrap;
            gap: 1rem;
            padding: 0;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
        }

        .category-track.centered {
            justify-content: center;
        }

        .category-track::-webkit-scrollbar {
            display: none;
        }

        .category-track {
            scrollbar-width: none;
        }

        .category-circle {
            flex: 0 0 auto;
            width: 120px;
            text-decoration: none;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 0.55rem;
            padding: 0.25rem 0;
            border-radius: 14px;
            transition: transform 0.2s ease;
            background: transparent;
            border: none;
            box-shadow: none;
            scroll-snap-align: start;
        }

        .category-circle:hover {
            transform: translateY(-2px);
        }

        .category-circle-image {
            width: 92px;
            height: 92px;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-circle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .category-circle-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
            min-height: calc(1.2em * 2);
        }

        @media (max-width: 480px) {
            .category-circle {
                width: 104px;
            }
            .category-circle-image {
                width: 80px;
                height: 80px;
            }
            .category-carousel .carousel-track-container {
                min-height: 155px;
            }
            .category-carousel {
                gap: 0.45rem;
            }
            .category-carousel .carousel-nav {
                width: 40px;
                height: 40px;
            }
        }

        /* Account Dropdown Styles */
        .account-menu {
            position: relative;
        }

        .account-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            min-width: 280px;
            z-index: 1000;
            border: 1px solid var(--border-primary);
        }

        .account-dropdown.hidden {
            display: none;
        }

        .account-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .account-section:last-child {
            border-bottom: none;
        }

        .account-section strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .account-link {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 0.2s;
            display: block;
            text-align: left;
            margin-top: 0.5rem;
        }

        .account-link:hover {
            background: var(--primary-100);
            border-color: var(--primary-400);
        }

        .account-link-danger {
            background: var(--error-bg);
            color: var(--error);
            border-color: var(--error);
        }

        .account-link-danger:hover {
            background: var(--error);
            color: white;
        }

        .account-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            padding: 0.25rem 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                
                Mountain Made
            </a>
            
            <ul class="navbar-menu">
                <li><a href="/" class="active">Home</a></li>
                <li><a href="/products">Products</a></li>
                <li><a href="#categories">Categories</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/contact">Contact Us</a></li>
                <li id="admin-link" class="hidden"><a href="/admin">Admin</a></li>
            </ul>
            
            <div class="navbar-actions">
                <div id="auth-buttons">
                    <a href="/login" class="btn btn-secondary btn-sm">Login</a>
                    <a href="/register" class="btn btn-primary btn-sm">Register</a>
                </div>
                
                <div id="user-menu" class="hidden flex gap-2" style="align-items: center;">
                    <a href="/cart" class="icon-button" title="Shopping Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-badge" class="cart-badge hidden">0</span>
                    </a>
                    <div class="account-menu">
                        <button id="account-toggle" class="icon-button" title="Account">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div id="account-dropdown" class="account-dropdown hidden">
                            <div class="account-section">
                                <strong>Account</strong>
                                <button class="account-link" onclick="openProfileModal()">Edit Profile</button>
                                <a href="/orders" class="account-link">My Orders</a>
                            </div>
                            <div class="account-section">
                                <strong>Account Management</strong>
                                <button class="account-link" onclick="openAccountManagementModal()">Change Password</button>
                            </div>
                            <div class="account-section">
                                <strong>Appearance</strong>
                                <button id="theme-toggle" class="account-link">Toggle Dark / Light</button>
                            </div>
                            <div class="account-section">
                                <button id="account-logout" class="account-link account-link-danger">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Search Bar / Hero Slider Section -->
    <section class="search-section" id="hero-slider-section">
        <!-- 5-image background slider -->
        <div class="hero-slides-container" id="hero-slides-container">
            <!-- Mobile-only dedicated background (overrides slider on small screens) -->
            <div id="mobile-hero-bg-wrap"></div>
            <div class="hero-slide" id="hero-slide-1"></div>
            <div class="hero-slide" id="hero-slide-2"></div>
            <div class="hero-slide" id="hero-slide-3"></div>
            <div class="hero-slide" id="hero-slide-4"></div>
            <div class="hero-slide" id="hero-slide-5"></div>
        </div>
        <!-- Navigation dots -->
        <div class="hero-slider-dots" id="hero-slider-dots"></div>
        <div class="search-container">
            <div id="search-hero-heading" class="search-heading hidden">
                <h1 id="homepage-hero-title-text"></h1>
                <p id="homepage-hero-subtitle-text"></p>
            </div>
            <div class="search-input-zone">
                <div class="search-input-wrapper">
                    <input type="text" id="home-search-input" class="search-input" placeholder="Search for products..." />
                    <button id="home-search-btn" class="search-button">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div id="home-search-suggestions" class="search-suggestions hidden"></div>
            </div>
            <div class="home-trust-strip" aria-label="Store trust indicators">
                <span class="home-trust-item"><i class="fas fa-shield-check"></i> Secure checkout</span>
                <span class="home-trust-item"><i class="fas fa-leaf"></i> Fresh quality products</span>
                <span class="home-trust-item"><i class="fas fa-truck"></i> Fast doorstep delivery</span>
            </div>
        </div>
    </section>

    <!-- Product Carousel Slider -->
    <section class="carousel-section">
        <div class="carousel-container">
            <h2 class="carousel-title">Featured Products</h2>
            <div class="carousel-wrapper">
                <button class="carousel-nav carousel-prev" id="carousel-prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="carousel-track-container">
                    <div class="carousel-track" id="carousel-track">
                        <div class="carousel-loader">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <button class="carousel-nav carousel-next" id="carousel-next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- Featured Deals Flip Cards -->
    <section class="flip-cards-section" id="flip-cards-section" style="display:none;">
        <div class="flip-cards-container">
            <div class="flip-cards-header">
                <h2>Featured Deals</h2>
                <span class="fc-badge"><i class="fas fa-bolt"></i> Hot</span>
            </div>
            <div class="flip-cards-grid" id="flip-cards-grid">
                <!-- Dynamically rendered by initFlipCards() -->
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section id="categories" class="container">
        <div class="section-title">
            <h2>Shop by Category</h2>
            <p>Explore our wide range of premium food products</p>
        </div>

        <div class="carousel-wrapper category-carousel" aria-label="Shop by Category">
            <button class="carousel-nav carousel-prev" id="categories-prev" type="button" aria-label="Previous categories">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="carousel-track-container">
                <div class="category-track" id="categories-track">
                    <div class="carousel-loader">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <button class="carousel-nav carousel-next" id="categories-next" type="button" aria-label="Next categories">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </section>

    

    <!-- Dynamic Homepage Sections -->
    <div id="homepage-sections-container"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-trust-row">
            <div class="trust-badge"><i class="fas fa-lock"></i><span>Safe payments</span></div>
            <div class="trust-badge"><i class="fas fa-award"></i><span>Quality checked</span></div>
            <div class="trust-badge"><i class="fas fa-rotate-left"></i><span>Hassle-free support</span></div>
            <div class="trust-badge"><i class="fas fa-truck-fast"></i><span>Quick dispatch</span></div>
        </div>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Mountain Made</h3>
                <p>Premium organic food products from mountain farms to your table.</p>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="/products">Products</a></li>
                    <li><a href="/#categories">Categories</a></li>
                    <li><a href="/about">About Us</a></li>
                    <li><a href="/register?type=wholesale">Wholesale</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Customer Service</h3>
                <ul>
                    <li><a href="/orders">My Orders</a></li>
                    <li><a href="/cart">Shopping Cart</a></li>
                    <li><a href="/contact">Contact Us</a></li>
                    <li><a href="#">FAQs</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Contact</h3>
                <ul>
                    <li><i class="fas fa-envelope"></i> hello@mountain-made.com</li>
                    <li><i class="fas fa-phone"></i> (555) 123-4567</li>
                    <li><i class="fas fa-map-marker-alt"></i> India, Manipur</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2026 Mountain Made. All rights reserved.</p>
        </div>
    </footer>

    <script src="/js/main.js"></script>
    <script>
        // In-memory data for homepage
        let homeCategories = [];
        let carouselProducts = [];
        let currentCarouselIndex = 0;

        function wireCategoryCarouselNav() {
            const track = document.getElementById('categories-track');
            const prev = document.getElementById('categories-prev');
            const next = document.getElementById('categories-next');
            if (!track || !prev || !next) return;

            const getGapPx = () => {
                const gap = window.getComputedStyle(track).gap || '0px';
                const parsed = parseFloat(gap);
                return Number.isFinite(parsed) ? parsed : 0;
            };

            const scrollStep = () => {
                const first = track.querySelector('.category-circle');
                const base = first ? first.getBoundingClientRect().width : 120;
                return Math.max(180, Math.round(base + getGapPx()));
            };

            const updateCentering = () => {
                // Center only when everything fits; otherwise start-aligned (no fake empty space).
                const fits = track.scrollWidth <= track.clientWidth + 2;
                track.classList.toggle('centered', fits);
            };

            prev.addEventListener('click', () => {
                track.scrollBy({ left: -scrollStep(), behavior: 'smooth' });
            });
            next.addEventListener('click', () => {
                track.scrollBy({ left: scrollStep(), behavior: 'smooth' });
            });

            window.addEventListener('resize', updateCentering);
            // Run once now and again after images load.
            updateCentering();
            setTimeout(updateCentering, 250);
        }

        // Load categories
        async function loadCategories() {
            try {
                const data = await api.get('/products/categories');
                homeCategories = data.categories || [];
                const track = document.getElementById('categories-track');
                
                if (homeCategories.length === 0) {
                    if (track) track.innerHTML = '<p class="text-center" style="width:100%;">No categories available</p>';
                    return;
                }

                if (!track) return;

                track.innerHTML = homeCategories.map(category => `
                    <a href="/products?category=${category.id}" class="category-circle" title="${category.name}">
                        <span class="category-circle-image">
                            <img src="${category.image_url || '/images/placeholder.jpg'}"
                                 alt="${category.name}"
                                 class="category-image"
                                 loading="lazy"
                                 decoding="async"
                                 onerror="this.src='/images/placeholder.jpg'">
                        </span>
                        <span class="category-circle-name">${category.name}</span>
                    </a>
                `).join('');
                if (window.optimizeDynamicImages) {
                    window.optimizeDynamicImages(track);
                }

                // Re-evaluate centering after DOM/images settle
                if (typeof window.requestAnimationFrame === 'function') {
                    requestAnimationFrame(() => {
                        const fits = track.scrollWidth <= track.clientWidth + 2;
                        track.classList.toggle('centered', fits);
                    });
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
                const track = document.getElementById('categories-track');
                if (track) {
                    track.innerHTML = '<p class="text-center" style="width:100%;">Failed to load categories</p>';
                }
            }
        }

        /* ── Hero Background Slider ── */
        let heroSliderState = { current: 0, total: 0, interval: null, images: [] };

        function initHeroSlider(settings) {
            const slides = document.querySelectorAll('.hero-slide');
            const dotsWrap = document.getElementById('hero-slider-dots');
            const images = [];

            for (let i = 1; i <= 5; i++) {
                const url = (settings[`slider_image_${i}`] || '').trim();
                if (url) images.push(url);
            }

            heroSliderState.images = images;
            heroSliderState.total = images.length;

            if (images.length === 0) {
                // Fallback: solid dark-green background, no dots
                slides.forEach(s => { s.style.backgroundImage = ''; s.classList.remove('active'); });
                slides[0].classList.add('active');
                if (dotsWrap) dotsWrap.innerHTML = '';
                return;
            }

            // Assign images to slide divs
            images.forEach((url, idx) => {
                if (slides[idx]) {
                    slides[idx].style.backgroundImage = `url('${url}')`;
                }
            });

            // Build dots (only for active images)
            if (dotsWrap) {
                dotsWrap.innerHTML = images.map((_, idx) =>
                    `<span class="hero-dot${idx === 0 ? ' active' : ''}" data-idx="${idx}"></span>`
                ).join('');
                dotsWrap.querySelectorAll('.hero-dot').forEach(dot => {
                    dot.addEventListener('click', () => {
                        goToSlide(parseInt(dot.getAttribute('data-idx'), 10));
                        resetHeroInterval();
                    });
                });
            }

            // Show first slide
            showSlide(0);

            if (heroSliderState.interval) clearInterval(heroSliderState.interval);
            if (images.length > 1) {
                heroSliderState.interval = setInterval(() => {
                    const next = (heroSliderState.current + 1) % heroSliderState.total;
                    goToSlide(next);
                }, 5000);
            }

            // On mobile: use first slider image as full-section background (shows behind the search bar)
            const section = document.getElementById('hero-slider-section');
            const mobileBgUrl = images[0] || '';
            if (section) {
                if (mobileBgUrl) {
                    section.style.backgroundImage = `url('${mobileBgUrl}')`;
                    section.classList.add('has-mobile-bg');
                } else {
                    section.style.backgroundImage = '';
                    section.classList.remove('has-mobile-bg');
                }
            }
        }

        function showSlide(idx) {
            const slides = document.querySelectorAll('.hero-slide');
            const dots = document.querySelectorAll('.hero-dot');
            slides.forEach((s, i) => s.classList.toggle('active', i === idx));
            dots.forEach((d, i) => d.classList.toggle('active', i === idx));
            heroSliderState.current = idx;
        }

        function goToSlide(idx) {
            showSlide(idx);
        }

        function resetHeroInterval() {
            if (heroSliderState.interval) clearInterval(heroSliderState.interval);
            if (heroSliderState.total > 1) {
                heroSliderState.interval = setInterval(() => {
                    const next = (heroSliderState.current + 1) % heroSliderState.total;
                    goToSlide(next);
                }, 5000);
            }
        }

        /* ── Flip Cards Section ── */
        const FLIP_CTA_COLORS = [
            'linear-gradient(90deg,#1e88e5,#1565c0)',
            'linear-gradient(90deg,#ff8c00,#e07000)',
            'linear-gradient(90deg,#2e8b57,#1b5e20)',
            'linear-gradient(90deg,#7b1fa2,#4a148c)',
            'linear-gradient(90deg,#c62828,#b71c1c)'
        ];

        let flipCardTimers = [];

        function startFlipCardAutoFlip() {
            // Clear any existing timers
            flipCardTimers.forEach(t => t.type === 'interval' ? clearInterval(t.id) : clearTimeout(t.id));
            flipCardTimers = [];

            const cards = document.querySelectorAll('.flip-card');
            if (!cards.length) return;

            cards.forEach((card, idx) => {
                // Stagger start so cards cascade (0ms, 400ms, 800ms, 1200ms, 1600ms)
                const staggerDelay = idx * 400;

                const tid = setTimeout(() => {
                    let flipped = false;
                    // Toggle flip every 2 seconds
                    const iv = setInterval(() => {
                        flipped = !flipped;
                        card.classList.toggle('auto-flipped', flipped);
                    }, 2000);
                    flipCardTimers.push({ type: 'interval', id: iv });
                }, staggerDelay);

                flipCardTimers.push({ type: 'timeout', id: tid });
            });
        }

        function initFlipCards(settings) {
            const section = document.getElementById('flip-cards-section');
            const grid   = document.getElementById('flip-cards-grid');
            if (!section || !grid) return;

            const cards = [];
            for (let i = 1; i <= 5; i++) {
                cards.push({
                    slot:  i,
                    front: (settings[`flip_card_front_${i}`] || '').trim(),
                    back:  (settings[`flip_card_back_${i}`]  || '').trim(),
                    label: (settings[`flip_card_label_${i}`] || '').trim(),
                    title: (settings[`flip_card_title_${i}`] || '').trim()
                });
            }

            const active = cards.filter(c => c.front || c.back);
            if (active.length === 0) {
                section.style.display = 'none';
                return;
            }

            grid.innerHTML = active.map((c) => {
                const ctaColor = FLIP_CTA_COLORS[(c.slot - 1) % FLIP_CTA_COLORS.length];
                const labelText = c.label || 'Shop Now';
                const backLabel = c.title || 'View Details';

                const frontImgHtml = c.front
                    ? `<img src="${c.front}" alt="${labelText}" class="flip-card-img" loading="lazy" onerror="this.style.display='none'">`
                    : `<div class="flip-card-placeholder"><i class="fas fa-image"></i></div>`;

                const backImgHtml = c.back
                    ? `<img src="${c.back}" alt="${backLabel}" class="flip-card-img" loading="lazy" onerror="this.style.display='none'">`
                    : (c.front
                        ? `<img src="${c.front}" alt="${backLabel}" class="flip-card-img" loading="lazy">`
                        : `<div class="flip-card-placeholder"><i class="fas fa-star"></i></div>`);

                return `
                <div class="flip-card-wrap" data-slot="${c.slot}">
                    <div class="flip-card" aria-label="${labelText} — auto-flipping card">
                        <div class="flip-card-inner">
                            <!-- Front -->
                            <div class="flip-card-front">
                                <div class="flip-card-img-wrap">${frontImgHtml}</div>
                                <span class="flip-card-ad-badge">AD</span>
                                <div class="flip-card-cta-bar" style="background:${ctaColor}">${labelText}</div>
                            </div>
                            <!-- Back -->
                            <div class="flip-card-back">
                                <div class="flip-card-img-wrap">${backImgHtml}</div>
                                <span class="flip-card-ad-badge">AD</span>
                                <div class="flip-card-cta-bar">${backLabel}</div>
                            </div>
                        </div>
                    </div>
                    ${c.title ? `<div class="flip-card-subtitle">${c.title}</div>` : ''}
                </div>`;
            }).join('');

            section.style.display = '';
            // Start auto-flip after a short delay so images can load
            setTimeout(startFlipCardAutoFlip, 800);
        }

        // Load dynamic homepage sections with products
        async function loadHomepageSections() {
            // Fetch settings first (independently) so slider always initialises
            // even if the sections endpoint fails.
            let settings = {};
            try {
                const settingsResp = await api.get('/products/settings');
                settings = (settingsResp && settingsResp.settings) || {};
            } catch (e) {
                console.warn('Could not load site settings:', e);
            }
            // Always init the hero slider and flip cards with whatever settings we have
            initHeroSlider(settings);
            initFlipCards(settings);

            // Apply hero heading text immediately from settings
            try {
                const heroWrap0 = document.getElementById('search-hero-heading');
                const heroTitleEl0 = document.getElementById('homepage-hero-title-text');
                const heroSubtitleEl0 = document.getElementById('homepage-hero-subtitle-text');
                const heroTitle0 = (settings.homepage_hero_title || '').trim();
                const heroSubtitle0 = (settings.homepage_hero_subtitle || '').trim();
                if (heroWrap0 && heroTitleEl0 && heroSubtitleEl0) {
                    if (heroTitle0 || heroSubtitle0) {
                        heroTitleEl0.textContent = heroTitle0;
                        heroSubtitleEl0.textContent = heroSubtitle0;
                        heroWrap0.classList.remove('hidden');
                    } else {
                        heroWrap0.classList.add('hidden');
                    }
                }
            } catch (_) {}

            try {
                const sectionsData = await api.get('/products/homepage-sections');

                const data = sectionsData || {};
                const sections = Array.isArray(data.sections) ? data.sections : [];

                const container = document.getElementById('homepage-sections-container');
                
                if (sections.length === 0) {
                    container.innerHTML = '<section class="container"><div class="section-title"><h2>Featured Products</h2><p>No homepage sections configured yet. Add a section in the admin panel and assign products to it to feature them here.</p></div></section>';
                    return;
                }
                
                let html = '';
                
                sections.forEach((section) => {
                    const sectionProducts = Array.isArray(section.products) ? section.products : [];
                    const sectionHeadingImageUrl = (section.heading_image_url || '').trim();
                    const safeSectionHeadingImageUrl = sectionHeadingImageUrl ? encodeURI(sectionHeadingImageUrl) : '';
                    const showHeadingImage = !!sectionHeadingImageUrl;
                    html += `
                        <section class="container">
                            <div class="section-title">
                                <div class="homepage-section-heading-wrap">
                                    <div class="homepage-section-heading-image-box ${showHeadingImage ? '' : 'hidden'}">
                                        <img class="homepage-section-heading-image" src="${showHeadingImage ? safeSectionHeadingImageUrl : ''}" alt="${section.name || 'Section'} heading image" loading="lazy" decoding="async" onerror="this.parentElement.classList.add('hidden')">
                                    </div>
                                    <div class="homepage-section-heading-text">
                                        <h2>${section.name}</h2>
                                        ${section.description ? `<p>${section.description}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-4">
                    `;

                    if (sectionProducts.length > 0) {
                        sectionProducts.forEach(product => {
                            html += `
                                <div class="card product-card">
                                    ${product.stock_quantity < 10 && product.stock_quantity > 0 ? 
                                        '<span class="product-badge">Low Stock</span>' : ''}
                                    ${product.stock_quantity === 0 ? 
                                        '<span class="product-badge" style="background: var(--error);">Out of Stock</span>' : ''}
                                    
                                    <a href="/product-details?id=${product.id}" style="text-decoration: none; color: inherit;">
                                        <img src="${product.image_url || '/images/placeholder.jpg'}" 
                                             alt="${product.name}" 
                                             class="card-image"
                                             loading="lazy"
                                             decoding="async"
                                             onerror="this.src='/images/placeholder.jpg'">
                                        
                                        <div class="card-content">
                                            <h3 class="card-title">${product.name}</h3>
                                            <p class="card-description">${product.description || ''}</p>
                                            
                                            ${(() => {
                                                const useWholesale = auth.isWholesale() && product.wholesale_price;
                                                const base = parseFloat(product.price || 0);
                                                const discount = product.discount_price != null ? parseFloat(product.discount_price) : null;
                                                const retail = discount != null && discount < base ? discount : base;
                                                const sale = useWholesale ? parseFloat(product.wholesale_price) : retail;
                                                const showDiscount = !useWholesale && discount != null && discount < base;
                                                if (useWholesale) {
                                                    return `<div class="product-price">${formatCurrency(sale)}</div><p class="stock-info">Min order: ${product.min_wholesale_qty} units</p>`;
                                                }
                                                if (showDiscount) {
                                                    return `<div class="product-price"><span class="price-original">${formatCurrency(base)}</span><span class="price-discount">${formatCurrency(retail)}</span></div>`;
                                                }
                                                return `<div class="product-price">${formatCurrency(sale)}</div>`;
                                            })()}
                                        </div>
                                    </a>
                                    
                                    <div class="card-footer" style="display:flex; flex-direction:column; align-items:stretch; gap:0.35rem;">
                                        ${(() => {
                                            const isWholesaleUser = !!(auth && typeof auth.isWholesale === 'function' && auth.isWholesale());
                                            const raw = isWholesaleUser ? parseInt(product.min_wholesale_qty || 10, 10) : 1;
                                            const minQty = isWholesaleUser
                                                ? (Number.isFinite(raw) && raw > 0 ? raw : 10)
                                                : 1;

                                            return `
                                                <div class="product-qty-row" style="display:flex; align-items:center; gap:0.25rem;">
                                                    <label for="home-qty-${product.id}" style="font-size:0.8rem; color:var(--text-light);">Qty${isWholesaleUser && minQty > 1 ? ` (min ${minQty})` : ''}</label>
                                                    <input type="number"
                                                           id="home-qty-${product.id}"
                                                           class="form-input"
                                                           value="${minQty}"
                                                           min="${minQty}"
                                                           step="${minQty}"
                                                           max="${product.stock_quantity || 99}"
                                                           style="width:64px; padding:0.25rem 0.35rem; font-size:0.85rem;">
                                                </div>
                                            `;
                                        })()}
                                        <div class="product-action-row" style="display:flex; align-items:center; gap:0.25rem; width:100%;">
                                            <button class="btn btn-primary btn-sm add-cart-cta" 
                                                    onclick="addToCart(${product.id})"
                                                    ${product.stock_quantity === 0 ? 'disabled' : ''}
                                                    style="flex:1; min-width:0; width:auto;">
                                                <i class="fas fa-cart-plus"></i>
                                                ${product.stock_quantity === 0 ? 'Out' : 'Add'}
                                            </button>
                                            <button class="btn btn-success btn-sm" 
                                                    onclick="buyNow(${product.id})"
                                                    ${product.stock_quantity === 0 ? 'disabled' : ''}
                                                    style="flex:1; min-width:0; width:auto;">
                                                <i class="fas fa-credit-card"></i> Buy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += `
                            <div class="card" style="grid-column: 1 / -1; text-align: center;">
                                <div class="card-content">
                                    <p>No products in this section yet. Add products in the admin panel and assign them to "${section.name}" to show them here.</p>
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                            <div class="text-center mt-3">
                                <a href="/products" class="btn btn-primary">View All Products</a>
                            </div>
                        </section>
                    `;
                });
                
                container.innerHTML = html;
                if (window.optimizeDynamicImages) {
                    window.optimizeDynamicImages(container);
                }
            } catch (error) {
                console.error('Failed to load homepage sections:', error);
                document.getElementById('homepage-sections-container').innerHTML = '<section class="container"><div class="section-title"><h2>Featured Products</h2><p>Unable to load featured sections right now. Please try again later.</p></div></section>';
            }
        }
        
        function getHomeQuantity(productId) {
            const input = document.getElementById(`home-qty-${productId}`);
            if (!input) return 1;

            const rawVal = parseInt(input.value, 10);
            const minQty = parseInt(input.min, 10);
            const stepQty = parseInt(input.step, 10);
            const maxQty = parseInt(input.max, 10);

            const min = Number.isFinite(minQty) && minQty > 0 ? minQty : 1;
            const step = Number.isFinite(stepQty) && stepQty > 0 ? stepQty : 1;
            const hasMax = Number.isFinite(maxQty) && maxQty > 0;

            let val = Number.isFinite(rawVal) && rawVal > 0 ? rawVal : min;

            if (hasMax && maxQty < step) {
                input.value = String(maxQty);
                return maxQty;
            }

            val = Math.max(min, val);
            if (hasMax) val = Math.min(val, maxQty);

            if (step > 1) {
                val = Math.ceil(val / step) * step;
                if (hasMax && val > maxQty) {
                    val = Math.floor(maxQty / step) * step;
                }
                val = Math.max(min, val);
            }

            if (hasMax) val = Math.min(val, maxQty);

            input.value = String(val);
            return val;
        }

        // Add to cart function
        async function addToCart(productId) {
            try {
                const quantity = getHomeQuantity(productId);
                await cart.add(productId, quantity);
                showAlert('Product added to cart!', 'success');
            } catch (error) {
                console.error('Add to cart error:', error);
                if (!auth.isAuthenticated()) {
                    showAlert('Please login to add items to cart', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                } else {
                    showAlert('Failed to add product to cart', 'error');
                }
            }
        }
        
        // Buy now function - route through checkout with selected quantity
        async function buyNow(productId) {
            try {
                const user = await auth.checkAuth();

                if (!user) {
                    showAlert('Please login to buy products', 'error');
                    setTimeout(() => {
                        window.location.href = '/login?redirect=/checkout';
                    }, 1500);
                    return;
                }

                const quantity = getHomeQuantity(productId);
                
                // Mark as direct buy before cart operations
                sessionStorage.setItem('directBuy', 'true');
                
                // Clear cart and add product
                await cart.clear();
                const addSuccess = await cart.add(productId, quantity);
                
                if (!addSuccess) {
                    sessionStorage.removeItem('directBuy');
                    showAlert('Failed to add product to cart. Please try again.', 'error');
                    return;
                }
                
                // Verify cart has items before redirecting
                const cartCheck = await cart.fetch();
                if (!cartCheck || !cartCheck.cartItems || cartCheck.cartItems.length === 0) {
                    sessionStorage.removeItem('directBuy');
                    showAlert('Failed to prepare checkout. Please try again.', 'error');
                    return;
                }
                
                // Redirect to checkout
                window.location.replace('/checkout');
            } catch (error) {
                console.error('Buy now error:', error);
                sessionStorage.removeItem('directBuy');
                showAlert(error.message || 'Failed to start checkout', 'error');
            }
        }
        
        function getCategoryIcon(name) {
            const icons = {
                'Fresh Produce': '🥬',
                'Dairy Products': '🧀',
                'Bakery': '🥖',
                'Meat & Poultry': '🥩',
                'Beverages': '🥤',
                'Snacks': '🍿'
            };
            return icons[name] || '🍽️';
        }
        
        async function loadCarouselProducts() {
            try {
            const data = await api.get('/products/carousel?limit=8');
                carouselProducts = data.products || [];
                
                if (carouselProducts.length === 0) {
                    document.getElementById('carousel-track').innerHTML = '<div class="carousel-loader"><p>No products available</p></div>';
                    return;
                }

                renderCarousel();
                startAutoSlide();
            } catch (error) {
                console.error('Failed to load carousel products:', error);
                document.getElementById('carousel-track').innerHTML = '<div class="carousel-loader"><p>Failed to load products</p></div>';
            }
        }

        function renderCarousel() {
            const track = document.getElementById('carousel-track');
            track.innerHTML = carouselProducts.map((product, index) => `
                <div class="carousel-item" onclick="location.href='/product-details?id=${product.id}'">
                    <img src="${product.image_url || '/images/placeholder.jpg'}" 
                         alt="${product.name}" 
                         class="carousel-item-image"
                         loading="${index === 0 ? 'eager' : 'lazy'}"
                         fetchpriority="${index === 0 ? 'high' : 'auto'}"
                         decoding="async"
                         onerror="this.src='/images/placeholder.jpg'">
                    <div class="carousel-item-content">
                        <h3 class="carousel-item-title">${product.name}</h3>
                        ${product.stock_quantity === 0
                            ? '<div class="carousel-stock-badge out">Out of Stock</div>'
                            : (product.stock_quantity > 0 && product.stock_quantity < 10
                                ? `<div class="carousel-stock-badge">Low Stock (${product.stock_quantity})</div>`
                                : '')}
                        ${(() => {
                            const base = parseFloat(product.price || 0);
                            const discount = product.discount_price != null ? parseFloat(product.discount_price) : null;
                            const retail = discount != null && discount < base ? discount : base;
                            if (discount != null && discount < base) {
                                return `<div class="carousel-item-price"><span class="price-original">${formatCurrency(base)}</span> <span class="price-discount">${formatCurrency(retail)}</span></div>`;
                            }
                            return `<div class="carousel-item-price">${formatCurrency(retail)}</div>`;
                        })()}
                        <div class="carousel-item-footer">
                            <button class="btn btn-primary btn-sm" 
                                    onclick="event.stopPropagation(); addToCart(${product.id})">
                                <i class="fas fa-cart-plus"></i> Add
                            </button>
                            <button class="btn btn-success btn-sm" 
                                    onclick="event.stopPropagation(); buyNow(${product.id})">
                                <i class="fas fa-credit-card"></i> Buy
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            if (window.optimizeDynamicImages) {
                window.optimizeDynamicImages(track);
            }
        }

        function slideCarousel(direction) {
            const track = document.getElementById('carousel-track');
            const itemWidth = 280 + 16; // item width + gap
            const visibleItems = Math.floor(track.parentElement.offsetWidth / itemWidth);
            const maxIndex = Math.max(0, carouselProducts.length - visibleItems);

            if (direction === 'next') {
                currentCarouselIndex = Math.min(currentCarouselIndex + 1, maxIndex);
            } else {
                currentCarouselIndex = Math.max(currentCarouselIndex - 1, 0);
            }

            track.style.transform = `translateX(-${currentCarouselIndex * itemWidth}px)`;
        }

        let autoSlideInterval;
        function startAutoSlide() {
            const autoSlideDelay = window.performanceTuning
                ? window.performanceTuning.getAdaptiveInterval(4000, {
                    lowMultiplier: 2,
                    highMultiplier: 0.75,
                    min: 3000,
                    max: 9000
                })
                : 4000;

            autoSlideInterval = setInterval(() => {
                const track = document.getElementById('carousel-track');
                const itemWidth = 280 + 16;
                const visibleItems = Math.floor(track.parentElement.offsetWidth / itemWidth);
                const maxIndex = Math.max(0, carouselProducts.length - visibleItems);

                if (currentCarouselIndex >= maxIndex) {
                    currentCarouselIndex = 0;
                } else {
                    currentCarouselIndex++;
                }

                track.style.transform = `translateX(-${currentCarouselIndex * itemWidth}px)`;
            }, autoSlideDelay);
        }

        function stopAutoSlide() {
            if (autoSlideInterval) {
                clearInterval(autoSlideInterval);
            }
        }

        // Search functionality
        function handleSearch() {
            const searchInput = document.getElementById('home-search-input');
            const query = searchInput.value.trim();
            if (query) {
                window.location.href = `/products?search=${encodeURIComponent(query)}`;
            }
        }

        function renderSearchSuggestions(suggestions, query) {
            const container = document.getElementById('home-search-suggestions');
            if (!container) return;

            if (!query || suggestions.length === 0) {
                container.innerHTML = suggestions.length === 0 && query
                    ? '<div class="search-suggestions-empty">No matches found</div>'
                    : '';
                container.classList.toggle('hidden', !query);
                return;
            }

            container.innerHTML = suggestions.map(item => {
                const image = item.image_url || '/images/placeholder.jpg';
                const typeLabel = item.type === 'category' ? 'Category' : 'Product';
                const meta = item.type === 'product' && item.price
                    ? (() => {
                        const base = parseFloat(item.price || 0);
                        const discount = item.discount_price != null ? parseFloat(item.discount_price) : null;
                        const retail = discount != null && discount < base ? discount : base;
                        if (discount != null && discount < base) {
                            return `${typeLabel} • ${formatCurrency(retail)} (was ${formatCurrency(base)})`;
                        }
                        return `${typeLabel} • ${formatCurrency(retail)}`;
                    })()
                    : typeLabel;

                return `
                    <div class="search-suggestion-item" data-type="${item.type}" data-id="${item.id}">
                        <img src="${image}" alt="${item.name}" class="search-suggestion-image" onerror="this.src='/images/placeholder.jpg'">
                        <div class="search-suggestion-text">
                            <div class="search-suggestion-name">${item.name}</div>
                            <div class="search-suggestion-meta">${meta}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.classList.remove('hidden');

            // Click handling
            container.querySelectorAll('.search-suggestion-item').forEach(el => {
                el.addEventListener('click', () => {
                    const type = el.getAttribute('data-type');
                    const id = el.getAttribute('data-id');

                    if (type === 'category') {
                        window.location.href = `/products?category=${encodeURIComponent(id)}`;
                    } else {
                        window.location.href = `/product-details?id=${encodeURIComponent(id)}`;
                    }
                });
            });
        }

        async function loadSearchSuggestions(query) {
            const trimmed = query.trim().toLowerCase();
            const container = document.getElementById('home-search-suggestions');
            if (!container) return;

            if (!trimmed) {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            }

            // Build suggestions from in-memory products and categories
            const productMatches = (carouselProducts || []).filter(p => {
                const name = (p.name || '').toLowerCase();
                return name.includes(trimmed);
            }).slice(0, 8).map(p => ({
                type: 'product',
                id: p.id,
                name: p.name,
                image_url: p.image_url,
                price: p.price
            }));

            const categoryMatches = (homeCategories || []).filter(c => {
                const name = (c.name || '').toLowerCase();
                return name.includes(trimmed);
            }).slice(0, 5).map(c => ({
                type: 'category',
                id: c.id,
                name: c.name,
                image_url: c.image_url
            }));

            const suggestions = [...productMatches, ...categoryMatches];
            renderSearchSuggestions(suggestions, trimmed);
        }

        function debounce(fn, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        const debouncedSuggestions = debounce(loadSearchSuggestions, 300);

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            wireCategoryCarouselNav();
            loadCategories();
            loadHomepageSections();
            loadCarouselProducts();

            // Wire carousel navigation
            document.getElementById('carousel-prev').addEventListener('click', () => {
                stopAutoSlide();
                slideCarousel('prev');
                startAutoSlide();
            });

            document.getElementById('carousel-next').addEventListener('click', () => {
                stopAutoSlide();
                slideCarousel('next');
                startAutoSlide();
            });

            // Wire search
            const searchInput = document.getElementById('home-search-input');
            const searchBtn = document.getElementById('home-search-btn');
            const suggestionsContainer = document.getElementById('home-search-suggestions');

            if (searchBtn) {
                searchBtn.addEventListener('click', handleSearch);
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });

                searchInput.addEventListener('input', (e) => {
                    debouncedSuggestions(e.target.value || '');
                });

                searchInput.addEventListener('focus', (e) => {
                    if (e.target.value && e.target.value.trim().length >= 2) {
                        debouncedSuggestions(e.target.value);
                    }
                });
            }

            // Hide suggestions on click outside
            document.addEventListener('click', (e) => {
                if (!suggestionsContainer) return;
                const isInsideSearch = e.target.closest('.search-container');
                if (!isInsideSearch) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            // Account dropdown toggle
            const accountToggle = document.getElementById('account-toggle');
            const accountDropdown = document.getElementById('account-dropdown');

            if (accountToggle && accountDropdown) {
                accountToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    accountDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.account-menu')) {
                        accountDropdown.classList.add('hidden');
                    }
                });
            }

            // Account logout handler
            const accountLogout = document.getElementById('account-logout');
            if (accountLogout) {
                accountLogout.addEventListener('click', async () => {
                    if (await showConfirmDialog('Are you sure you want to logout?', { title: 'Logout', confirmText: 'Logout' })) {
                        await auth.logout();
                    }
                });
            }
        });
    </script>
</body>
</html>
